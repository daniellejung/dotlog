<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Dot Log — Your daily routines</title>
<meta name="theme-color" content="#4D96FF">
<link rel="manifest" href="manifest.webmanifest">

<style>
:root{
  --bg:#ffffff;           /* 전체 배경 */
  --surface:#ffffff;      /* 카드/버튼 면 */
  --ink:#1f2937;          /* 기본 글자 */
  --muted:#6b7280;        /* 보조 글자 */
  --line:#e5e7eb;         /* 경계선 */
  --shadow:0 4px 18px rgba(0,0,0,.06);
  --accent:#4D96FF;       /* 포인트 블루 */
  --danger:#ef4444;
}

*{box-sizing:border-box}
html,body{
  margin:0;padding:0;background:var(--bg);color:var(--ink);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji";
  -webkit-font-smoothing:antialiased;
  overflow-x:hidden; /* 가로 스크롤 방지 */
}
.safe{padding:max(env(safe-area-inset-top),12px) 12px max(env(safe-area-inset-bottom),16px)}

header{
  position:sticky;top:0;z-index:10;background:var(--bg);
  border-bottom:1px solid var(--line);
  backdrop-filter:saturate(180%) blur(8px);
}
h1{font-size:18px;margin:0 0 6px 0;font-weight:700;letter-spacing:.2px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

.controls input[type="month"]{
  border:1px solid var(--line);border-radius:12px;padding:8px 12px;background:var(--surface);color:var(--ink);
  min-width:180px;
  box-shadow:var(--shadow);
}

button{
  border:1px solid var(--line);background:var(--surface);color:var(--ink);
  border-radius:12px;padding:9px 12px;font-weight:600;
  box-shadow:var(--shadow);
}
button:active{transform:translateY(1px)}
.primary{background:var(--accent);color:#fff;border-color:transparent}
.danger{background:var(--danger);color:#fff;border-color:transparent}

.card{
  background:var(--surface);border:1px solid var(--line);
  border-radius:16px;padding:12px;box-shadow:var(--shadow);
  max-width:100%;
}
.legend{display:flex;flex-wrap:wrap;gap:8px}
.legend-item{
  display:flex;align-items:center;gap:8px;border:1px dashed var(--line);
  border-radius:999px;padding:6px 10px;background:var(--surface)
}
.dot{border-radius:50%;border:1px solid #0001}

.tip{font-size:12px;color:var(--muted)}
.tools{display:flex;gap:8px;flex-wrap:wrap;max-width:100%}

/* 달력: 7등분 고정, 한 화면에 꽉 차게 */
.calendar{
  width:100%;
  table-layout:fixed;
  border-collapse:collapse;
}
.calendar th,.calendar td{
  width:14.2857%;
  border:1px solid var(--line);
  padding:8px 4px;
  vertical-align:top;
  height:72px;          /* 충분한 세로 높이 */
  background:var(--surface);
  position:relative;
  overflow-wrap:break-word;
}
.calendar th{
  background:#fafafa;
  font-size:12px;font-weight:700;color:#111827;
}
.daynum{position:absolute;top:6px;right:6px;color:var(--muted);font-size:11px}
.muted{color:var(--muted)}
.spill{background:#fcfcfc}

/* 도트: 3개마다 줄바꿈 + 더 큰 크기 */
.dots{
  display:grid;
  grid-template-columns:repeat(3, clamp(12px, 3.2vw, 18px));
  gap:clamp(5px, 1.6vw, 8px);
  margin-top:20px;
  align-content:start;
}
.dots .dot{
  width:clamp(12px, 3.2vw, 18px);
  height:clamp(12px, 3.2vw, 18px);
  border-radius:50%; border:1px solid #0001;
}

/* Color swatches (routine add) */
.swatches{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin-top:6px}
.swatch{
  width:36px;height:36px;border-radius:50%;
  border:1px solid var(--line); box-shadow:0 2px 8px rgba(0,0,0,.06);
}
.swatch.is-selected{outline:3px solid var(--accent); outline-offset:2px}

/* 작은 화면 튜닝 */
@media (max-width:430px){
  .calendar th,.calendar td{padding:7px 3px}
  .daynum{top:5px;right:5px;font-size:10px}
  h1{font-size:17px}
}

/* Bottom sheets */
.sheet{
  position:fixed;left:0;right:0;bottom:-100%;
  background:var(--surface);border-top-left-radius:16px;border-top-right-radius:16px;
  box-shadow:0 -8px 24px rgba(0,0,0,.18);padding:12px;border:1px solid var(--line);
  transition:bottom .25s ease;
}
.sheet.open{bottom:0}
.sheet h3{margin:0 0 8px 0;font-size:16px}
.grid{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
</style>
</head>

<body>
<header class="safe">
  <div class="row" style="justify-content:space-between;align-items:flex-start">
    <div>
      <h1>Dot Log</h1>
      <div class="tip">Local only · PWA · Sunday first</div>
    </div>
    <div class="controls row">
      <button id="prevBtn">◀︎</button>
      <input id="monthPicker" type="month">
      <button id="nextBtn">▶︎</button>
    </div>
  </div>
  <div class="tools" style="margin-top:8px">
    <button id="addRoutineBtn" class="primary">Add routine</button>
    <button id="exportBtn">Backup JSON</button>
    <button id="importBtn">Import JSON</button>
    <button id="widgetBtn">Export for Widget</button>
    <button id="clearBtn" class="danger">Clear all</button>
  </div>
</header>

<main class="safe" style="padding-top:12px">
  <section class="card">
    <h2 style="font-size:16px;margin:0 0 8px 0">Routines</h2>
    <div id="legend" class="legend"></div>
  </section>

  <section class="card" style="margin-top:12px">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2 style="font-size:16px;margin:0">Calendar</h2>
      <div class="tip">Tap a day to add via dropdown</div>
    </div>
    <table id="calendar" class="calendar"></table>
  </section>

  <section class="card" style="margin-top:12px">
    <h2 style="font-size:16px;margin:0 0 6px 0">Stats (this month)</h2>
    <div id="stats" class="tip">No data yet.</div>
  </section>
</main>

<!-- 날짜 입력 시트 -->
<div id="sheet" class="sheet" aria-hidden="true">
  <h3 id="sheetTitle">Add entry</h3>
  <div class="grid">
    <label for="selRoutine">Routine</label>
    <select id="selRoutine"
      style="border:1px solid var(--line);border-radius:10px;padding:10px 12px;background:var(--surface);color:var(--ink)"></select>
  </div>
  <div class="grid" style="margin-top:8px">
    <label for="selCount">Count</label>
    <select id="selCount"
      style="border:1px solid var(--line);border-radius:10px;padding:10px 12px;background:var(--surface);color:var(--ink)">
      <option value="1">1 time</option>
      <option value="2">2 times</option>
      <option value="3">3 times</option>
    </select>
  </div>
  <div class="row" style="margin-top:12px;justify-content:flex-end">
    <button id="removeBtn">Remove last</button>
    <button id="addBtn" class="primary">Add</button>
  </div>
</div>

<!-- 루틴 추가 시트 (이름 + 색상 칩) -->
<div id="routineSheet" class="sheet" aria-hidden="true">
  <h3 style="margin-bottom:10px">Add a routine</h3>
  <div class="grid">
    <label for="routineName">Name</label>
    <input id="routineName" type="text" placeholder="e.g., Workout"
           style="border:1px solid var(--line);border-radius:10px;padding:10px 12px;background:var(--surface);color:var(--ink)">
  </div>
  <div class="grid" style="margin-top:10px">
    <label>Color</label>
    <div id="routineSwatches" class="swatches"></div>
  </div>
  <!-- 선택된 색을 저장 -->
  <input id="routineColor" type="hidden" value="#4E6156">
  <div class="row" style="margin-top:12px;justify-content:flex-end">
    <button id="routineCancel">Cancel</button>
    <button id="routineConfirm" class="primary">Add</button>
  </div>
</div>

<input id="fileInput" type="file" accept="application/json" style="display:none"/>

<script>
/* ---------- Helpers ---------- */
const $ = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
const pad = n => String(n).padStart(2,'0');

/* ---------- Pastel Palette (hex only) ---------- */
const PALETTE = [
  "#4E6156","#9E7C74","#DFB0B1","#DFA95C","#CBCABD","#EAD3BF",
  "#C1E7E3","#D6B7E1","#F6C49E","#B8C39C","#C5DAF1","#B8A899"
];

/* ---------- Store ---------- */
const store = {
  key: 'dotlog-local-routines-v1',
  read(){
    try{ return JSON.parse(localStorage.getItem(this.key)) || {routines:[], entries:{}} }catch(_){ return {routines:[], entries:{}} }
  },
  write(data){ localStorage.setItem(this.key, JSON.stringify(data)); },
  clear(){ localStorage.removeItem(this.key); }
}
let data = store.read();

/* ---------- Elements ---------- */
const monthPicker = $('#monthPicker');
const cal = $('#calendar');
const legend = $('#legend');
const statsBox = $('#stats');

const sheet = $('#sheet');
const selRoutine = $('#selRoutine');
const selCount = $('#selCount');
const addBtn = $('#addBtn');
const removeBtn = $('#removeBtn');

const routineSheet = $('#routineSheet');
const routineName = $('#routineName');
const routineSwatches = $('#routineSwatches');
const routineColor = $('#routineColor');
const routineCancel = $('#routineCancel');
const routineConfirm = $('#routineConfirm');

const addRoutineBtn = $('#addRoutineBtn');
const fileInput = $('#fileInput');

/* ---------- Init Month Picker ---------- */
const today = new Date();
monthPicker.value = `${today.getFullYear()}-${pad(today.getMonth()+1)}`;

/* ---------- Routines CRUD ---------- */
function uuid(){ return 'r'+Math.random().toString(36).slice(2,10); }

function addRoutine(name, color){
  data.routines.push({ id:uuid(), name, color, created:Date.now() });
  store.write(data);
  renderLegend(); renderCalendar(); renderStats();
}
function deleteRoutine(id){
  for(const d of Object.keys(data.entries)){
    data.entries[d] = (data.entries[d]||[]).filter(x=>x!==id);
    if(data.entries[d].length===0) delete data.entries[d];
  }
  data.routines = data.routines.filter(r=>r.id!==id);
  store.write(data);
  renderLegend(); renderCalendar(); renderStats();
}

/* ---------- Entries ---------- */
function addEntry(date, routineId, count){
  const arr = data.entries[date] || [];
  for(let i=0;i<count;i++) arr.push(routineId);
  data.entries[date] = arr;
  store.write(data);
}
function removeLast(date){
  const arr = data.entries[date] || [];
  arr.pop();
  if(arr.length===0) delete data.entries[date]; else data.entries[date] = arr;
  store.write(data);
}

/* ---------- Legend ---------- */
function escapeHtml(str){return str.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
function renderLegend(){
  legend.innerHTML = '';
  if(!data.routines.length){ legend.innerHTML = '<div class="tip">No routines yet. Tap "Add routine".</div>'; return; }
  for(const r of data.routines){
    const el = document.createElement('div');
    el.className = 'legend-item';
    el.innerHTML = `<span class="dot" style="width:14px;height:14px;background:${r.color}"></span><span>${escapeHtml(r.name)}</span>`;
    const del = document.createElement('button');
    del.textContent = 'Delete';
    del.onclick = ()=>{ if(confirm('Delete this routine?')) deleteRoutine(r.id); };
    el.appendChild(del);
    legend.appendChild(el);
  }
}

/* ---------- Calendar ---------- */
function ymd(d){ return d.toISOString().slice(0,10); }
function monthGrid(year, month){ // month: 1..12
  const first = new Date(year, month-1, 1);
  const last = new Date(year, month, 0);
  const start = new Date(first); start.setDate(first.getDate() - first.getDay()); // Sunday
  const end = new Date(last);   end.setDate(last.getDate() + (6 - last.getDay())); // Saturday
  const weeks = []; let d = new Date(start);
  while(d <= end){
    const row = [];
    for(let i=0;i<7;i++){ row.push(new Date(d)); d.setDate(d.getDate()+1); }
    weeks.push(row);
  }
  return {weeks, first, last};
}

function renderCalendar(){
  const [y,m] = monthPicker.value.split('-').map(Number);
  const {weeks} = monthGrid(y,m);
  const thead = `<thead><tr><th>SUN</th><th>MON</th><th>TUE</th><th>WED</th><th>THU</th><th>FRI</th><th>SAT</th></tr></thead>`;
  const rows = weeks.map(week=>{
    const tds = week.map(d=>{
      const inMonth = (d.getMonth()+1)===m;
      const dateStr = ymd(d);
      const arr = data.entries[dateStr] || [];
      const dots = arr.map(rid=>{
        const r = data.routines.find(x=>x.id===rid);
        const color = r ? r.color : '#ddd';
        return `<span class="dot" title="${escapeHtml(r? r.name:'')}" style="background:${color}"></span>`;
      }).join('');
      return `<td class="${inMonth? '':'spill'}" data-date="${dateStr}">
        <span class="daynum ${inMonth?'':'muted'}">${d.getDate()}</span>
        <div class="dots">${dots}</div>
      </td>`;
    }).join('');
    return `<tr>${tds}</tr>`;
  }).join('');
  cal.innerHTML = thead + `<tbody>${rows}</tbody>`;
  $$('#calendar td').forEach(td=>{ td.onclick = ()=>openSheet(td.getAttribute('data-date')); });
}

/* ---------- Day Sheet ---------- */
let currentDate = null;
function openSheet(dateStr){
  currentDate = dateStr;
  $('#sheetTitle').textContent = `Add entry — ${dateStr}`;
  selRoutine.innerHTML = data.routines.map(r=>`<option value="${r.id}">${escapeHtml(r.name)}</option>`).join('');
  if(!data.routines.length){ selRoutine.innerHTML = `<option disabled>(add a routine first)</option>`; }
  sheet.classList.add('open'); sheet.setAttribute('aria-hidden','false');
}
function closeSheet(){ sheet.classList.remove('open'); sheet.setAttribute('aria-hidden','true'); }

addBtn.onclick = ()=>{
  if(!data.routines.length){ alert('Add a routine first.'); return; }
  addEntry(currentDate, selRoutine.value, Number(selCount.value));
  renderCalendar(); renderStats(); closeSheet();
};
removeBtn.onclick = ()=>{ removeLast(currentDate); renderCalendar(); renderStats(); };

// 스와이프로 닫기
let startY=null;
sheet.addEventListener('touchstart',e=>{ startY = e.touches[0].clientY; });
sheet.addEventListener('touchmove',e=>{ if(startY!==null){ const dy=e.touches[0].clientY-startY; if(dy>30){ closeSheet(); startY=null; } } });

/* ---------- Add Routine Sheet ---------- */
function renderSwatches(){
  routineSwatches.innerHTML = PALETTE.map(hex =>
    `<button class="swatch" type="button" data-hex="${hex}" style="background:${hex}"></button>`
  ).join('');
  selectSwatch(routineColor.value || PALETTE[0]);
  routineSwatches.querySelectorAll('.swatch').forEach(btn=>{
    btn.onclick = ()=> selectSwatch(btn.dataset.hex);
  });
}
function selectSwatch(hex){
  routineColor.value = hex;
  routineSwatches.querySelectorAll('.swatch').forEach(b=>b.classList.remove('is-selected'));
  const active = Array.from(routineSwatches.children).find(b=>b.dataset.hex===hex);
  if(active) active.classList.add('is-selected');
}
function openRoutineSheet(){
  renderSwatches();
  routineName.value = '';
  routineSheet.classList.add('open');
  routineSheet.setAttribute('aria-hidden','false');
  setTimeout(()=>routineName.focus(),0);
}
function closeRoutineSheet(){
  routineSheet.classList.remove('open');
  routineSheet.setAttribute('aria-hidden','true');
}
routineConfirm.onclick = ()=>{
  const name = (routineName.value||'').trim();
  const color = routineColor.value || PALETTE[0];
  if(!name){ alert('Please enter a routine name.'); return; }
  addRoutine(name, color);
  closeRoutineSheet();
};
routineCancel.onclick = ()=> closeRoutineSheet();
let rsStartY=null;
routineSheet.addEventListener('touchstart',e=>{ rsStartY = e.touches[0].clientY; });
routineSheet.addEventListener('touchmove',e=>{ if(rsStartY!==null){ const dy=e.touches[0].clientY-rsStartY; if(dy>30){ closeRoutineSheet(); rsStartY=null; } } });

/* ---------- Stats ---------- */
function renderStats(){
  const [y,m] = monthPicker.value.split('-').map(Number);
  const monthPrefix = `${y}-${pad(m)}-`;
  const countsByRoutine = Object.fromEntries(data.routines.map(r=>[r.id,0]));
  let activeDays = new Set();
  for(const [date, arr] of Object.entries(data.entries)){
    if(date.startsWith(monthPrefix)){
      arr.forEach(rid => countsByRoutine[rid]=(countsByRoutine[rid]||0)+1);
      if(arr.length) activeDays.add(date);
    }
  }
  const totalActiveDays = activeDays.size;
  const totalDots = Object.entries(data.entries)
    .filter(([d,_])=>d.startsWith(monthPrefix))
    .reduce((a,[_,arr])=>a+arr.length,0);

  const lines = data.routines.map(r=>`• ${escapeHtml(r.name)}: ${countsByRoutine[r.id]||0}`);
  statsBox.innerHTML = lines.length
    ? (`<div>${lines.join('<br>')}</div><div class="tip" style="margin-top:6px">Days active: ${totalActiveDays} · Total dots: ${totalDots}</div>`)
    : 'No data yet.';
}

/* ---------- Toolbar actions ---------- */
addRoutineBtn.onclick = openRoutineSheet;

$('#exportBtn').onclick = ()=>{
  const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = `dotlog-backup-${Date.now()}.json`; a.click(); URL.revokeObjectURL(a.href);
};
$('#importBtn').onclick = ()=> fileInput.click();
fileInput.onchange = async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const text = await f.text();
  try{
    const obj = JSON.parse(text);
    if(obj && obj.routines && obj.entries){ data = obj; store.write(data); renderLegend(); renderCalendar(); renderStats(); alert('Imported.'); }
    else alert('Invalid file.');
  }catch(err){ alert('Invalid JSON.'); }
};
$('#widgetBtn').onclick = ()=>{
  const [y,m] = monthPicker.value.split('-').map(Number);
  const monthPrefix = `${y}-${pad(m)}-`;
  const compact = { month: monthPrefix, routines: data.routines, entries: {} };
  for(const [d, arr] of Object.entries(data.entries)){ if(d.startsWith(monthPrefix)) compact.entries[d] = arr; }
  const blob = new Blob([JSON.stringify(compact)],{type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = `dotlog-widget-${monthPrefix}.json`; a.click(); URL.revokeObjectURL(a.href);
};
$('#clearBtn').onclick = ()=>{ if(confirm('Clear all data?')){ store.clear(); data = store.read(); renderLegend(); renderCalendar(); renderStats(); } };

/* ---------- Month nav ---------- */
$('#prevBtn').onclick = ()=>shiftMonth(-1);
$('#nextBtn').onclick = ()=>shiftMonth(1);
monthPicker.onchange = ()=>{ renderCalendar(); renderStats(); };
function shiftMonth(delta){
  const [y,m] = monthPicker.value.split('-').map(Number);
  const d = new Date(y, m-1+delta, 1);
  monthPicker.value = `${d.getFullYear()}-${pad(d.getMonth()+1)}`;
  renderCalendar(); renderStats();
}

/* ---------- PWA: service worker ---------- */
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{ navigator.serviceWorker.register('sw.js').catch(()=>{}); });
}

/* ---------- Initial render ---------- */
renderLegend(); renderCalendar(); renderStats();
</script>
</body>
</html>
